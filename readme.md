# 📋 Premium Task Calendar - 개발 요약 보고서

본 프로젝트는 기존 JSON 파일 시스템 기반의 할 일 관리 애플리케이션을 **MySQL 데이터베이스 기반의 통합 관리 시스템**으로 전환하여, 데이터 안정성과 기기 간(PC/모바일) 동기화 기능을 대폭 강화한 서비스입니다.

---

## 🚀 주요 기능 및 개발 사항

### 1. 데이터베이스 마이그레이션 (JSON → MySQL)
*   **기존**: 날짜별 `.json` 파일에 저장하던 방식을 탈피하여 중앙 집중형 DB 시스템 구축.
*   **신규**: `todos` 테이블 하나로 모든 데이터를 관리하며, 날짜별 조회 및 통합 검색이 가능하도록 인덱싱 최적화.

### 2. 통합 API 엔진 구축 (`api.php`)
*   **전체 동기화 (Full Sync)**: 화면의 데이터와 DB의 정합성을 맞추기 위해, 저장 시 해당 날짜의 데이터를 갱신(Update) 또는 교체(Replace)하는 안정적인 로직 적용.
*   **지능형 재사용 목록 (강화)**: 전체 `todos` 테이블에서 사용자가 자주 입력하거나 최근에 사용한 할 일을 분석하여 최대 **100개**의 고유 리스트를 추천. 단순히 최근 기록이 아닌 전체 데이터를 기반으로 한 지능형 재사용 엔진.
*   **캘린더 대시보드**: 월별 할 일 개수를 한눈에 파악할 수 있도록 데이터베이스 기반의 카운팅 엔진 구현.

### 3. 모바일 실시간 동기화 지원
*   **네트워크 공유**: 로컬 서버(예: XAMPP) 환경에서 PC의 IP 주소를 통해 모바일 기기에서도 동일한 데이터베이스에 접속 및 편집 가능. (권장 접속 주소: `http://192.168.219.106/index.html`)
*   **반응형 대응**: PC와 모바일 어디서든 동일한 사용자 경험을 제공하도록 API 처리 방식 통일.

### 4. 시스템 최적화 및 보안
*   **자동 초기화**: `action=init` 명령어를 통해 복잡한 SQL 설정 없이 브라우저에서 즉시 테이블 생성 및 최적화 가능.
*   **오류 보정**: 날짜 데이터 누락이나 데이터 형식 불일치 시 서버 단에서 자동으로 보정하여 저장 실패 방지.

---

## ✨ 개선된 기능 (최근 업데이트)

### 할일 목록 순서 고정 (위치 저장)
*   **순서 유지**: 할일 목록의 순서를 바꾼 뒤 저장하면, 해당 순서가 DB에 `sort_order`로 저장되어 다시 불러와도 그대로 유지됩니다.
*   **자동 마이그레이션**: 배포 서버에 `sort_order` 컬럼이 없어도, 저장 시 자동으로 컬럼을 추가한 뒤 순서를 반영합니다. 별도 DB 수동 수정 없이 동작합니다.
*   **조회 정렬**: 할일 목록 조회 시 `sort_order` → `created_at` → `id` 순으로 정렬하여 항상 동일한 순서로 표시됩니다.

### 순서 변경 전용 페이지 (`reorder.html`)
*   **드래그 앤 드롭**: 목록 항목을 끌어다 놓아 순서를 변경할 수 있습니다.
*   **↑ / ↓ 버튼**: 드래그가 불편한 환경에서도 위·아래 버튼으로 한 칸씩 순서를 조정할 수 있습니다.
*   **순서 저장**: 날짜를 선택하고 「불러오기」 → 순서 변경 → 「순서 저장」을 누르면 해당 날짜의 순서가 서버에 반영됩니다. 메인 앱에서 같은 날짜를 열면 변경된 순서로 표시됩니다.

### 저장 안정성 강화
*   **빈 저장 방지**: 저장 요청 시 유효한 항목이 하나도 없으면 기존 데이터를 삭제하지 않고, DB에 있는 현재 목록을 그대로 반환합니다. 실수로 목록이 사라지는 것을 막습니다.
*   **다중 필드 지원**: 프론트에서 전달하는 텍스트 필드를 `text` 뿐 아니라 `content`, `todo_text`, `label` 등으로 보내도 인식하여 저장합니다.
*   **새 항목 ID**: 새로 추가된 항목에 `id`가 없거나 비어 있어도 서버에서 타임스탬프 기반 ID를 부여하여 저장 오류를 방지합니다.

### DB 설정 공통화 (`config.php`)
*   **한 곳에서 관리**: DB 접속 정보(호스트, DB명, 계정, 비밀번호)를 `config.php`에서만 수정하면 됩니다. `api.php`와 `setup_db.php`가 이 파일을 불러와 사용합니다.
*   **배포 편의**: 서버 환경에 맞게 `config.php`만 수정하면 로컬·배포 환경 모두 대응할 수 있습니다.

### AI 기반 남은 할 일 제언 (Claude 인사이트)
*   **통계 보기 시 자동 제언**: 「통계 보기」를 누르면 리포트 팝업이 열리면서 자동으로 Claude API를 호출해 남은 할 일에 대한 제언(요약, 의미론적 패턴, 인지 부하, 병목 분석, 개선 대책, 동기부여 문구)을 불러와 표시합니다. 별도 「인사이트 생성」 버튼 없이 한 번에 확인할 수 있습니다.
*   **API 키는 메인에서만 설정**: Claude API 키는 **메인 화면 상단**의 입력창에서만 입력·저장·연결 확인합니다. 리포트 팝업 안에는 키 입력란을 두지 않아, 팝업에서는 제언 결과만 보이도록 단순화했습니다.
*   **연결 시 입력창 자동 숨김**: API 키가 이미 연결되어 있으면 키 입력창과 「키 저장」 버튼은 숨기고, 「Claude API가 연결되어 있습니다.» 문구만 표시합니다. 미연결일 때만 입력창이 보입니다. (`api.php?action=checkClaudeKey`로 설정 여부 확인)
*   **심리 분석 강화**: 인사이트 프롬프트(`insights_prompt.txt`)를 개선해, 통계 요약뿐 아니라 동기·의지, 정서·부담, 에너지·스트레스, 회피·완벽주의 등 **심리적 해석**과 구체적인 개선 대책·동기부여 문구가 항상 채워지도록 했습니다.
*   **저장 위치**: API 키는 서버의 **`.env`** 파일에 `CLAUDE_API_KEY=` 형태로만 저장되며, 화면에는 다시 표시되지 않습니다. `.gitignore`에 `.env`를 포함해 저장소에 키가 올라가지 않도록 했습니다.

### 리포트 팝업 UI 개선
*   **제언 블록은 팝업 안에만**: 제언 영역이 팝업창 밖으로 나가지 않도록, 리포트 내용을 가진 div 중 **가장 안쪽(innermost)** 컨테이너를 찾아 그 안에만 제언 블록을 넣습니다.
*   **버튼 정리**: 「알림 테스트」 버튼은 제거하고, 「다시 시도」「확인」 버튼은 제언 영역 **맨 아래 푸터**에 배치해 스크롤 끝에서 함께 보이도록 했습니다.
*   **한 스크롤로 전체 보기**: 팝업 콘텐츠에 `max-height: 90vh`, `overflow-y: auto`를 적용해 위쪽 통계·할 일 목록부터 맨 아래 제언·버튼까지 **한 개의 세로 스크롤**로 모두 볼 수 있게 했습니다.
*   **팝업이 앞에 보이도록**: API 키 상단 바의 `z-index`를 1000으로 낮춰, 리포트 팝업(모달)이 API 키 확인 창보다 **위에** 표시되도록 했습니다.

### 인사이트 생성 안정성
*   **DB 컬럼 확장**: `user_productivity_insights.cognitive_load_type`을 VARCHAR(100)에서 **TEXT**로 변경해, 심리 분석으로 길어진 응답도 잘리지 않도록 했습니다. 기존 DB는 인사이트 생성 시 자동으로 ALTER 되어 반영됩니다.
*   **Overloaded 자동 재시도**: Claude API가 일시적으로 「Overloaded」 또는 529/503을 반환하면 **최대 3회** 자동 재시도(2초·4초 간격)합니다.
*   **다시 시도 버튼**: 제언 로드에 실패하면 팝업에 「다시 시도」 버튼이 나타나, 같은 팝업에서 한 번 더 요청할 수 있습니다.

---

## 🛠 실행 및 운영 방법

### 1. 웹 서버 환경 설정 (필수)
*   본 애플리케이션은 PHP와 MySQL을 사용하므로 **XAMPP**와 같은 로컬 웹 서버가 실행 중이어야 합니다.
*   **Apache**와 **MySQL** 모듈이 활성화되어 있는지 확인해 주세요.

### 2. 데이터베이스 초기화
*   서버 실행 후 브라우저 주소창에 아래 주소를 입력하여 테이블을 생성 및 최적화합니다.
    *   `http://localhost/api.php?action=init`

### 3. 접속 주소 안내
*   **PC 접속**: `http://localhost/index.html`
*   **모바일 접속**: 같은 와이파이에 연결된 상태에서 `http://192.168.219.106/index.html`
*   **할 일 순서 변경**: `http://localhost/reorder.html` — 날짜 선택 후 목록을 드래그하여 순서를 바꾸고 "순서 저장"을 누르면 해당 순서가 유지됩니다.

---

## 📂 파일 구조
*   `index.html`: 메인 사용자 인터페이스 (PWA 서비스 워커 및 필수 메타 데이터 포함)
*   `reorder.html`: 할일 순서 변경 전용 페이지 (드래그 + ↑↓ 버튼으로 순서 변경 후 「순서 저장」)
*   `api.php`: 데이터베이스 연동, 비즈니스 로직, 지능형 재사용 목록 엔진 및 Claude 인사이트 API를 담당하는 핵심 파일
*   `config.php`: DB 연결 정보(호스트, DB명, 계정, 비밀번호) — 배포 시 이 파일만 수정
*   `setup_db.php`: 데이터베이스·테이블 최초 생성 시 사용 (config.php의 DB 정보 사용)
*   `insights_prompt.txt`: Claude 인사이트 생성을 위한 시스템 프롬프트 템플릿
*   `assets/`: **(필수)** UI 디자인(CSS)과 앱 동작 로직(JS)이 담긴 핵심 폴더. 삭제 시 앱이 작동하지 않음.
*   `result/`: (레거시) 기존 JSON 파일 저장 경로 및 백업 데이터

---
**최종 업데이트**: 2026년 2월 25일  
**상태**: DB 통합·할일 순서 고정·저장 안정성 강화·AI 제언(Claude 인사이트)·리포트 팝업 UI·인사이트 안정성 적용 완료
